# Backend structure

The .NET web API uses the Model-View-Controller pattern, though the View doesn't really exist since we render JSON entities instead of actual views.

## Models
The models in the top-level `Models` directory are the actual entities as they appear in the database.

### Creating an entity
To register a model to be added into the database, first the class with all the data being stored should be added into the top-level `Models` directory. This class should inherit from `BaseEntity` and not define any of the following: Id, CreatedAt, UpdatedAt.
Next, in `Models/TaskTreeContext.cs` a `DbSet` should be added with the name of the database table.
Now create a migration to update the database with your entity table using the following command:
`dotnet ef migrations add [MigrationNameInPascalCase]`
This command will add a file to the `Migrations` directory that will update the database with your entity.

Finally, to actually propagate the change to the database, you need to run the following command:
`dotnet ef database update`

### Request objects
When accepting data from an API call, there is almost never a case where all the data an entity stores should be modifiable. For example, a user should never be able to specify their own ID as this is generated by the database on the rows creation.
To remedy this, a request class should be defined in `Models/Requests` containing the data accepted for specific requests. For example, `CreateUserRequest.cs` and `UpdateUserRequest.cs` hold the data that is accepted for creating and updating a user, respectively.

### Response objects
When returning data, there are cases when returning the entity stored in the database is undesirable. For example, with user entities it is likely that the password hash stored in the database won't want to be returned.
In this case, a response object should be created in `Models/Responses` which contains the fields that should be returned. Then in the controllers, this type should be returned.


## Controllers
The controllers in the `Controllers` directory essentially routes API requests and decides what the response is.

### Creating a controller
Creating a controller with simple CRUD actions is pretty straight-forward, Visual Studio provides a scaffolding tool for API controllers. When creating a scaffolded item, look for the 'API Controller with actions, using Entity Framework' option, and configure that as necessary.
Remember, any action that will create or update tables should have an associated Request object in `Models/Requests`.

**NOTE: Change the class the controller inherits to `TaskTreeControllerBase` from `ControllerBase`**

### AutoMapper
After accepting a Request object in the controller actions, it will need to be converted into an actual database entity. Rather than doing this conversion manually, TaskTree uses a project called [AutoMapper](https://github.com/AutoMapper/AutoMapper). It is almost completely automatic, but some manual work is needed to get it working.

#### Creating a mapping
In `Models/MappingProfiles/MappingProfile.cs`, add a `CreateMap<Source, Dest>()` function, where `Source` is original type and `Dest` is the type being converted to. If you want to ensure that null fields won't override non-null fields when merging objects (useful when updating entities), you can use the `CreateMapNoNull` helper we have defined in the `MappingProfile` class.

#### Using a mapping
Now define a private property on the controller you wish to use AutoMapper on:
`private readonly IMapper _mapper;`
Then, modify the controller's construtor to accept an `IMapper` object and set the `_mapper` property to that.

The mapper can now be used by calling the following function:
`_mapper.Map(source, dest);`

For an in-depth example, check out the `Controllers/UsersController.cs`.

### Authorized routes
When a route needs to have an associated user, use the `[Authorize]` decorator above the route that needs authorization. Inside the route, check if the user is wrong using `CurrentUserIdDoesNotMatch(requestedId)`. Again, check the `Controllers/UserController.cs` for an example.
